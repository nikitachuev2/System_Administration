# Managed by Ansible (role_nginx_proxy)

upstream clickhouse_backend {
{% for h in groups['clickhouse'] %}
    server {{ hostvars[h].inventory_hostname }}.{{ dc_domain }}:{{ ch_http_port|default(8123) }} max_fails=2 fail_timeout=5s;
{% endfor %}
    keepalive 64;
}

map $http_x_request_id $reqid { default $http_x_request_id; "" $request_id; }

log_format json escape=json
  '{ "ts":"$time_iso8601","remote":"$remote_addr","req":"$request","status":$status,'
  ' "rt":$request_time,"urt":"$upstream_response_time","upstream":"$upstream_addr","req_id":"$reqid" }';

server {
    listen 80 default_server;
    server_name _;

    access_log /var/log/nginx/access.json json;
    error_log  /var/log/nginx/error.log warn;

    location /healthz { return 200; }

    location / {
        proxy_set_header Host              $host;
        proxy_set_header X-Real-IP         $remote_addr;
        proxy_set_header X-Forwarded-For   $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Request-Id      $reqid;

        proxy_http_version 1.1;
        proxy_set_header Connection "";

        proxy_next_upstream error timeout http_502 http_503 http_504;
        proxy_read_timeout 10s;
        proxy_send_timeout 10s;

        proxy_pass http://clickhouse_backend;
    }
}
