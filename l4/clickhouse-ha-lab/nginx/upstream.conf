# Подключается из /etc/nginx/nginx.conf:
# include /etc/nginx/conf.d/upstream.conf;

upstream clickhouse_backend {
    server ch-s1-r1.dc.local:8123 max_fails=2 fail_timeout=5s;
    server ch-s1-r2.dc.local:8123 max_fails=2 fail_timeout=5s;
    server ch-s1-r3.dc.local:8123 max_fails=2 fail_timeout=5s;

    server ch-s2-r1.dc.local:8123 max_fails=2 fail_timeout=5s;
    server ch-s2-r2.dc.local:8123 max_fails=2 fail_timeout=5s;
    server ch-s2-r3.dc.local:8123 max_fails=2 fail_timeout=5s;

    server ch-s3-r1.dc.local:8123 max_fails=2 fail_timeout=5s;
    server ch-s3-r2.dc.local:8123 max_fails=2 fail_timeout=5s;
    server ch-s3-r3.dc.local:8123 max_fails=2 fail_timeout=5s;

    # Держим keepalive-коннекты к ClickHouse
    keepalive 64;
}

# JSON-лог, где видно upstream_addr и статус
log_format json_clickhouse escape=json
    '{'
    '"time":"$time_iso8601",'
    '"remote_addr":"$remote_addr",'
    '"request":"$request",'
    '"status":$status,'
    '"body_bytes_sent":$body_bytes_sent,'
    '"request_time":$request_time,'
    '"upstream_addr":"$upstream_addr",'
    '"upstream_status":"$upstream_status",'
    '"upstream_response_time":"$upstream_response_time"'
    '}';

server {
    listen 80;
    server_name vip.dc.local;

    access_log /var/log/nginx/access_clickhouse.json json_clickhouse;
    error_log  /var/log/nginx/error_clickhouse.log;

    # Локальный health-check VIP (не проксируется)
    location = /ping {
        return 200 "OK\n";
    }

    location / {
        proxy_pass http://clickhouse_backend;

        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header Connection "";

        proxy_connect_timeout 1s;
        proxy_read_timeout    60s;

        # Пассивный health-check:
        # при ошибке/таймауте уходим на следующую ноду
        proxy_next_upstream error timeout http_502 http_503 http_504;
    }
}
